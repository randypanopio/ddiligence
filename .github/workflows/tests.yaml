name: Executes Tests

on:
  push:
    branches:
      - staging
      - main
  pull_request:
    branches:
        - staging
        - main

# Tags:
# skips all tests [skip-all], also checks if tag is set by admin
# runs ONLY necessary tests and workflows of client_react [client_react]
# runs ONLY necessary tests of firebase cloud functions [firebase_functions]
# runs ONLY necessary tests and workflows of Flask API backend [app_flask]


jobs:
  check-commit-tags:
    runs-on: ubuntu-latest    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if commit message contains [skip-all]
        id: check_skip_all
        run: |
          if grep -qiE "\[skip-all\]" <<< "$(git log --format=%B -n 1 ${{ github.sha }})"; then
            echo "[skip-all] tag found in commit message."
            echo "::set-output name=skip_all::true"
          else
            echo "[skip-all] tag not found in commit message."
            echo "::set-output name=skip_all::false"
          fi

  check-admin-perms:
    runs-on: ubuntu-latest
    needs: check-commit-tags
    if: needs.check-commit-tags.outputs.skip_all != 'true'
    steps:
      - name: Check user permissions
        uses: actions-cool/check-user-permission@v2
        id: check
        with:
          require: 'admin'
          check-contributor: true
    
      - name: Check if user is admin
        run: |
          if [[ "${{ steps.check.outputs.user-permission }}" == "admin" ]]; then
            echo "User is an admin. Skipping pipeline execution."
            exit 0  # Exit with success code
          else
            echo "User is not an admin. Failing the job."
            exit 1  # Exit with failure code
          fi

  # check-tags-client_react:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #     - name: Check commit message for specific tags to run client_react testsuite
  #       run: |
  #         if grep -qiE 
  #         "\[app_flask\]|\[firebase_functions\]|\[skip-all\]|\[skip ci\]" 
  #         <<< "$(git log --format=%B -n 1 ${{ github.sha }})"; 
  #         then
  #           echo 
  #           "Skipping client react tests as commit message contains one of the following:            
  #           [app_flask], [firebase_functions], [skip-all], or [skip ci]."
  #           exit 78  # Exit with a neutral code
  #         else
  #           echo "Proceeding with client_react test suite"
  #         fi
         
