name: Executes Tests

on:
  push:
    branches:
      - staging
      - main
  pull_request:
    branches:
        - staging
        - main

# Tags:
# skips all tests [skip-all], also checks if tag is set by admin
# runs ONLY necessary tests and workflows of client_react [client_react]
# runs ONLY necessary tests of firebase cloud functions [firebase_functions]
# runs ONLY necessary tests and workflows of Flask API backend [app_flask]

jobs:
  run-client_react-suite:
    runs-on: ubuntu-latest
    needs: check-tags-and-run
    if: ${{ needs.check-tags-and-run.outputs.run_client_react == 'true' || needs.check-tags-and-run.outputs.run_all_suites == 'true' }}
    steps:
      - name: run suite
        run: echo "run_client_react-suite"     

  run-firebase_functions-suite:
    runs-on: ubuntu-latest
    needs: check-tags-and-run
    if: ${{ needs.check-tags-and-run.outputs.run_firebase_functions == 'true' || needs.check-tags-and-run.outputs.run_all_suites == 'true' }}
    steps:
      - name: run suite
        run: echo "run_firebase_functions-suite"     
      # Steps to run firebase_functions tests...

  run-app_flask-suite:
    runs-on: ubuntu-latest
    needs: check-tags-and-run
    if: ${{ needs.check-tags-and-run.outputs.run_app_flask == 'true' || needs.check-tags-and-run.outputs.run_all_suites == 'true' }}
    steps:
      - name: run suite
        run: echo "run-app_flask-suite"      
      # Steps to run app_flask tests...

  check-tags-and-run:
    runs-on: ubuntu-latest
    outputs:
      run_client_react: ${{ steps.set_client_react.outputs.client_react }}
      run_firebase_functions: ${{ steps.set_firebase_functions.outputs.firebase_functions }}
      run_app_flask: ${{ steps.set_app_flask.outputs.app_flask }}
      run_all_suites: ${{ steps.set_all_suites.outputs.all_suites }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if commit message contains [client_react]
        id: set_client_react
        run: |
          if grep -qiE "\[client_react\]" <<< "$(git log --format=%B -n 1 ${{ github.sha }})"; then
            echo "::set-output name=client_react::true"
            echo "::set-output name=run_all_suites::true"
          else
            echo "::set-output name=client_react::false"
          fi

      - name: Check if commit message contains [firebase_functions]
        id: set_firebase_functions
        run: |
          if grep -qiE "\[firebase_functions\]" <<< "$(git log --format=%B -n 1 ${{ github.sha }})"; then
            echo "::set-output name=firebase_functions::true"
            echo "::set-output name=run_all_suites::true"
          else
            echo "::set-output name=firebase_functions::false"
          fi

      - name: Check if commit message contains [app_flask]
        id: set_app_flask
        run: |
          if grep -qiE "\[app_flask\]" <<< "$(git log --format=%B -n 1 ${{ github.sha }})"; then
            echo "::set-output name=app_flask::true"
            echo "::set-output name=run_all_suites::true"
          else
            echo "::set-output name=app_flask::false"
          fi
